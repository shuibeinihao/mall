define(["jquery"],function(i){"use strict";function a(a,e){a=i.extend({msg:"",onebutton:!1},a),r?r.find(".js-dialog-cancel").off().on(c,function(i){u(i),r.hide()}).end().find(".js-dialog-ok").off().on(c,function(i){u(i),e&&"function"==typeof e&&e(),r.hide()}).end():r=i(l).find(".js-dialog-cancel").off().on(c,function(i){u(i),r.hide()}).end().find(".js-dialog-ok").off().on(c,function(i){u(i),e&&"function"==typeof e&&e(),r.hide()}).end().appendTo("body"),a.msg&&(r.hide(),r.find(".js-msg").html(a.msg),a.onebutton?r.find(".js-dialog-cancel").hide():r.find(".js-dialog-cancel").show(),r.show())}function e(i){v||(v=f()),i?v.fadeIn():v.hide()}function t(a){i("#xinbi-notification .amount").text(a),i("#xinbi-notification").fadeIn(),setTimeout(function(){i("#xinbi-notification").fadeOut()},2e3)}function n(){i(".js-images").on(c,".js-remove",function(a){a.preventDefault(),a.stopPropagation();var e=i(a.currentTarget),t=e.data("index");e.parent().remove(),p.splice(t,1);var n=i(".js-add");n.is(":hidden")&&p.length<m&&n.show()});var a=function(a){return i.Deferred(function(i){var e=new FileReader;e.onload=function(a){i.resolve(a.target.result)},e.onerror=i.reject,e.readAsDataURL(a)}).promise()},e=function(a,e){var t=i("#template").html(),n=i(t).find(".js-remove").data("index",p.length).end().find("img").attr("src",a).end(),o=i(".js-add");o.before(n),p.push(e),p.length>=m&&o.hide()};i(".js-file").change(function(i){var t=i.target.files,n=t.length;n&&Array.prototype.slice.call(t,0,Math.min(n,m-p.length)).forEach(function(i){a(i).then(function(a){e(a,i)})})})}i="default"in i?i.default:i;var o="ontouchstart"in window,s=o?"touchstart":"click",d=window.location;i(function(){o&&i("a.js-a").on(s,function(i){i.preventDefault(),i.stopPropagation(),d.href=i.currentTarget.href})});var c=s,l='<div class="ui-dialog-wrapper ui-alert ui-row"><div class="ui-row-cell ui-row-cell-middle"><div class="ui-dialog"><div class="ui-dialog-msg js-msg"></div><div class="ui-dialog-btns js-btns"><span class="ui-dialog-button ui-touchable js-dialog-cancel">取消</span><span class="ui-dialog-button ui-touchable js-dialog-ok">确定</span></div></div></div></div>',r=void 0,u=function(i){i.preventDefault(),i.stopPropagation()},v=void 0,f=function(){return i('<div class="ui-dialog-wrapper ui-alert ui-row"><div class="ui-row-cell ui-row-cell-middle"><span class="loadingtip-msg js-msg" style="padding:1rem;border-radius: 5px;"><div class="spinner"><div class="spinner-container container1"><div class="circle1"></div><div class="circle2"></div><div class="circle3"></div><div class="circle4"></div></div><div class="spinner-container container2"><div class="circle1"></div><div class="circle2"></div><div class="circle3"></div><div class="circle4"></div></div><div class="spinner-container container3"><div class="circle1"></div><div class="circle2"></div><div class="circle3"></div><div class="circle4"></div></div></div></span></div></div>').appendTo("body")},p=[],m=3;i(document).ready(n),i(document).on(c,".js-star",function(a){var e=a.target,t=i(e).attr("data-star-level"),n=i(e).closest(".js-item");i(n).find('[name="starLevel"]').val(t),i(n).find("[data-star-level]").each(function(a,e){i(e).attr("data-star-level")<=t?(i(e).addClass("icon-font-star-active"),i(e).removeClass("icon-font-star")):(i(e).addClass("icon-font-star"),i(e).removeClass("icon-font-star-active"))})}).on(c,".js-submit",function(){var n=new FormData,o=!0;if(i(".js-item").each(function(e,t){var s=i(t).find('[name="starLevel"]').val();if(s<1||s>5)return a({msg:"请对商品进行评分",onebutton:!0}),void(o=!1);var d=i(t).find('[name="productId"]').val(),c=i(t).find('[name="subOrderId"]').val(),l=i(t).find('[name="content"]').val().trim();n.append("productId",d),n.append("subOrderId",c),n.append("starLevel",s),n.append("content",l),p.length&&p.forEach(function(i){n.append("file",i)})}),!0===o){var s=i(".js-submit").attr("data-productId");e(!0),i.ajax({url:"/api/zuul/trade/comment/save-file-comment",method:"POST",processData:!1,contentType:!1,data:n,success:function(i){i&&i.success?(e(!1),i.data.scoreEarned&&t(i.data.scoreEarned),mixpanel.track("MobileMall: Evaluate: Submit",{state:'@"success"}'}),xksTrack.track("MobileMall:Evaluate:Submit",{productId:s,state:"success"}),a({msg:"评论成功",onebutton:!0},function(){window.location="/gp/me?state=1"})):(e(!1),mixpanel.track("MobileMall: Evaluate: Submit",{state:'@"fail"}'}),xksTrack.track("MobileMall:Evaluate:Submit",{productId:s,state:"fail"}),a({msg:i.retMsg,onebutton:!0}))},error:function(i,t){mixpanel.track("MobileMall: Evaluate: Submit",{state:'@"fail"}'}),xksTrack.track("MobileMall:Evaluate:Submit",{productId:s,state:"fail"});var n="评论失败，请稍后再试。";e(!1),"timeout"===t&&(n="网络超时"),413===i.status&&(n="上传图片过大"),a({msg:n,onebutton:!0})}})}})});
